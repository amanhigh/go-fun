# Instructions

This file contains guidelines for coding, testing, and examples on coding style to follow.

## Coding

### Interfaces and Implementations
- Include constructor for each class in the same file with interface and class.
  - Example: FileManager (Interface), FileManagerImpl (Class), NewFileManager (*FileManagerImpl) (Constructor) - Return Pointer

### Parameters and Dependencies
- Parameters to New (Constructor) and Provider (Injector) methods should be interfaces, not pointers.
- For data objects, use structs, not pointers to structs, in parameters and return types.
- In constructors, pass only required fields. Example: Pass base URL instead of full config object.
- Except for pure util functions, most functions will have ctx as the first parameter.
- See `components/kohan/clients/sbi.go` for `NewSBIClient` constructor example
- See `components/kohan/manager/sbi_manager.go` for `NewSBIManager` constructor example

### Dependency Injection
- Update injector for new classes for that component.
- See `components/kohan/core/inject.go` for dependency injection patterns using golobby/container
- See provider methods like `provideSBIClient` and `provideSBIManager` for examples

### Logging and Error Handling
- Use Logrus for logging. In Repository and Manager, return app-specific errors. Example: common.HttpError or what is being followed.
- See `models/common/http.go` for HttpError interface and `NewHttpError` implementation
- See `common/util/error.go` for error processing utilities like `ResponseProcessor` and `ProcessValidationError`

### Utilities
- Use Common Module's Util and Helper packages where applicable.
- See `common/util/` directory for various utility functions like `UnwrapRequest` in `http.go`, error processing in `error.go`, and test helpers in `test.go`
- Avoid using the same variable name as imports to prevent conflicts. Example: Avoid tax variable if tax.CapitalGain is imported (see `models/tax/gains.go` for Gains struct definition)

## Testing

### Test Structure
- Refer to components/fun-app/it/fun_test.go - it uses a nesting style building user stories on each other.
- Do operations in BeforeEach and cleanup in AfterEach. Tests lie in the center. BeforeEach helps other Contexts which need that setup to be available.
- Another example is components/learn/frameworks/play/zoo_test.go - in this Context builds on each. Example: Write followed by Update & Watch. Similar structure is followed by vault_test.go in the same folder.

### Test Data Management
- For test data, keep test data closest to It (test blocks) in BeforeEach blocks for each Context to enhance readability and localization. Common setup should be in higher-level BeforeEach.

### Test Assertions
- Use `Expect(value).To(Equal(expected))` for exact value comparisons instead of `BeNumerically("~", expected)` wherever possible

### Ginkgo Test Execution
- **IMPORTANT: Do NOT use `cd` with ginkgo commands**
- ✅ Correct: `ginkgo -r components/kohan/manager`
- ❌ Wrong: `cd components/kohan/manager && ginkgo -r`
- Always specify the full path from the project root

### Mocking
- Mocks can be generated by Mockery (generate tag). Example: SBIClient in `components/kohan/clients/sbi.go`. These are not added to the knowledge base; you can assume they exist if the file has the tag. Example: go:generate mockery --name SBIClient
- **Use `make generate` to generate mocks** - do not run `go generate` directly to ensure consistency across all modules
- Don't use gomock; use the testify mock package where required. Example: mock.Anything (see `components/kohan/manager/capital_gain_manager_test.go` for usage examples)
- See `components/kohan/clients/mocks/SBIClient.go` for generated mock example

## Examples

### Interface, Implementation, and Constructor
- See `components/kohan/clients/sbi.go` for real SBIClient interface and implementation example
- See `components/kohan/manager/sbi_manager.go` for SBIManager interface and implementation example
- See `components/kohan/repository/exchange.go` for repository pattern examples
```go
// Interface, Implementation and Constructor in same file
type FileManager interface {
    ReadFile(ctx context.Context, path string) (FileContent, error)
    WriteFile(ctx context.Context, content FileContent) error
}

type FileManagerImpl struct {
    basePath string
    client   StorageClient
}

// Constructor returns pointer, takes interfaces as params
func NewFileManager(client StorageClient, basePath string) *FileManagerImpl {
    return &FileManagerImpl{
        basePath: basePath,  // Only required field passed
        client:   client,    // Interface not pointer
    }
}

// In Provider/Injector Return Pointer, Params as Interface
func provideFileManager(client StorageClient, config config.AppConfig) *FileManagerImpl {
    return NewFileManager(client, config.StoragePath) // Pass only required config field
}

// Data object as value, not pointer
type FileContent struct {
    Name    string
    Content []byte
    Size    int64
}
```

### Test Example Showing Nesting Pattern
- See `components/learn/frameworks/play/zoo_test.go` for real Zookeeper testing with Context nesting
- See `components/kohan/manager/capital_gain_manager_test.go` for manager testing patterns
- See `components/kohan/clients/sbi_client_test.go` for client testing with testcontainers
```go
// Test Example showing nesting pattern
func TestFileManager(t *testing.T) {
    var (
        fileManager FileManager
        client      StorageClient
        content     FileContent
    )

    BeforeEach(func() {
        client = NewMockStorageClient()
        fileManager = NewFileManager(client, "/tmp")
        content = FileContent{
            Name:    "test.txt",
            Content: []byte("hello"),
        }
    })

    AfterEach(func() {
        // Cleanup resources
    })

    Context("Write Operations", func() {
        BeforeEach(func() {
            err := fileManager.WriteFile(ctx, content)
            Expect(err).ToNot(HaveOccurred())
        })

        It("should write file successfully", func() {
            // Verify write
        })

        Context("Read After Write", func() {
            var readContent FileContent

            BeforeEach(func() {
                var err error
                readContent, err = fileManager.ReadFile(ctx, content.Name)
                Expect(err).ToNot(HaveOccurred())
            })

            It("should read written content correctly", func() {
                Expect(readContent).To(Equal(content))
            })
        })
    })
}
```

## Key Files Reference
### Configuration
- `models/config/common.go` - Common configuration structs and defaults
- `.mockery.yaml` - Mockery configuration for mock generation
- `.golangci.yml` - Linting configuration with strict rules and complexity limits

### Error Handling
- `models/common/http.go` - HttpError interface and standard error definitions
- `common/util/error.go` - Error processing utilities and validation error handling